name: üê≥ Construir y Subir Imagen Docker de la API

on:
  push: 
    branches:
      - main
      - master
    paths:
      # Se dispara solo si cambian archivos clave en la ra√≠z
      - 'package.json'
      - 'main.js'
      - 'Dockerfile'
      - '.github/workflows/docker-push.yml'
  workflow_dispatch: # Permite ejecutar el flujo de trabajo manualmente desde GitHub

env:
  # Nombre de la imagen en Docker Hub: usa tu usuario de GitHub/el nombre del repo
  DOCKER_USERNAME: johny050824
  DOCKER_IMAGE_NAME: johny050824/api_docker_compose
  DOCKER_TAG: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: docker
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Configurar Docker Buildx
        # Herramienta para construir im√°genes de manera eficiente
        uses: docker/setup-buildx-action@v3

      - name: üîë Login a Docker Hub
        # Utiliza los Secrets configurados en GitHub (Docker Username y Password/Token)
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Construir y Subir Imagen Docker
        uses: docker/build-push-action@v5
        with:
          # Contexto: . (la ra√≠z del repositorio)
          context: . 
          # Archivo: Dockerfile (en la ra√≠z)
          file: ./Dockerfile
          push: true
          tags: ${{env.DOCKER_IMAGE_NAME}}:${{ env.DOCKER_TAG }}
          # Opcional: uso de cach√© para construcciones m√°s r√°pidas
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=inline

      - name: Mostrar informaci√≥n de la imagen
        run: |
          echo "Imagen construida y subida exitosamente:"
          echo "  - Imagen: ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_TAG }}"
          echo "  - Docker Hub: https://hub.docker.com/r/johny050824/api_docker_compose/tags"

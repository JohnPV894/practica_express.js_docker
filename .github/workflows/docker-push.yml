name: ğŸ³ Construir y Subir Imagen Docker de la API

on:
  push:
    branches:
      - main
      - master
    paths:
      # Se dispara solo si cambian archivos clave en la raÃ­z
      - 'package.json'
      - 'main.js'
      - 'Dockerfile'
      - '.github/workflows/docker-push.yml'
  workflow_dispatch: # Permite ejecutar el flujo de trabajo manualmente desde GitHub

env:
  # Nombre de la imagen en Docker Hub: usa tu usuario de GitHub/el nombre del repo
  DOCKER_IMAGE_NAME: johny050824/api_docker_compose
  DOCKER_TAG: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Configurar Docker Buildx
        # Herramienta para construir imÃ¡genes de manera eficiente
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login a Docker Hub
        # Utiliza los Secrets configurados en GitHub (Docker Username y Password/Token)
        uses: docker/login-action@v3
        with:
          Token: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Construir y Subir Imagen Docker
        uses: docker/build-push-action@v5
        with:
          # Contexto: . (la raÃ­z del repositorio)
          context: . 
          # Archivo: Dockerfile (en la raÃ­z)
          file: Dockerfile 
          push: true
          tags: api_docker_compose:V
          # Opcional: uso de cachÃ© para construcciones mÃ¡s rÃ¡pidas
          cache-from: type=registry,ref=api_docker_compose:buildcache
          cache-to: type=inline

      - name: Mostrar informaciÃ³n de la imagen
        run: |
          echo "Imagen construida y subida exitosamente:"
          echo "  - Imagen: api_docker_compose:${{ env.DOCKER_TAG }}"
          echo "  - Docker Hub: https://hub.docker.com/r/johny050824/api_docker_compose/tags"
